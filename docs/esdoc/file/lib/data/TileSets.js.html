<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/data/TileSets.js | pixeldeck</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="2d pixel-graphic environment"><meta property="og:type" content="website"><meta property="og:url" content="https://github.com/BadQuanta/pixeldeck"><meta property="og:site_name" content="pixeldeck"><meta property="og:title" content="pixeldeck"><meta property="og:image" content="http://my-library.org/logo.png"><meta property="og:description" content="2d pixel-graphic environment"><meta property="og:author" content="https://github.com/BadQuanta"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="pixeldeck"><meta property="twitter:description" content="2d pixel-graphic environment"><meta property="twitter:image" content="http://my-library.org/logo.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.gif" style="width:34px;"></a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/foo/bar"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-repl">repl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-arch">arch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-cfg">cfg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dbg">dbg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pixeldeck">pixeldeck</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data">data</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/data/TileMaps.js~TileMaps.html">TileMaps</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/data/_Model.js~_Model.html">_Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TileSets">TileSets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LokiJs">LokiJs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-base">base</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#evt">evt</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Restart">Restart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Start">Start</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Stop">Stop</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#service">service</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRoot">getRoot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTileMapSvg">getTileMapSvg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTileSetSvg">getTileSetSvg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-app">app</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-index">index</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/data/TileSets.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">module.exports = TileSets
TileSets.list = listTileSets
TileSets.loadJson = loadJson
TileSets.jsonPathFrom = jsonPathFrom
TileSets.forPath = forPath
const dbg = require(&apos;../dbg&apos;).extend(&apos;Tileset&apos;)
const data = require(&apos;./&apos;)
TileSets.collection = data.base.addCollection(&apos;tilesets&apos;, {
  indices: [&apos;path&apos;,&apos;hostPath&apos;],
  unique: [&apos;path&apos;,&apos;hostPath&apos;]
})

/**
 * Give me something to load.
 * @param {*} json is pretty much just any kind of data.
 * @memberof data
 */
function TileSets (json) {
  const query = {}
  Object.keys(json).forEach((key) =&gt; {
    if (typeof json[key] !== &apos;object&apos;) {
      query[key] = json[key]
    }
  })
  const record = TileSets.collection.findOne(query) || TileSets.collection.insert(json)
  let imageDataUrl;
  const dbgg = dbg.extend(record.name)
  const tileset = {
    get record () { return record },
    get columns () { return record.columns },
    get image () { return record.image },
    get imageheight () { return record.imageheight },
    get imagewidth () { return record.imagewidth },
    get margin () { return record.margin },
    get name () { return record.name },
    get spacing () { return record.spacing },
    get terrains () { return record.terrains },
    get tilecount () { return record.tilecount },
    get tiledversion () { return record.tiledversion },
    get tileheight () { return record.tileheight },
    get tilewidth () { return record.tilewidth },
    get tiles () { return record.tiles },
    get tilewidth () { return record.tilewidth },
    get type () { return record.type },
    get version () { return record.version },
    get imageHostPath () { return Path.join(Path.dirname(record.hostPath), record.image) },
    get imageDataUrl () {

      if (!record.imageDataUrl) {
        dbgg(&apos;loading tileset image into data uri from %o&apos;, tileset.imageHostPath)
        const datauri = require(&apos;datauri&apos;)
        record.imageDataUrl = (new datauri(tileset.imageHostPath)).content
        tileset.update()
      } else {
        dbgg(&apos;image data already loaded...&apos;)
      }
      return record.imageDataUrl
    },
    update(values={}){
      Object.assign(record,values)
      return TileSets.collection.update(record)
    }
  }
  return tileset
}

const Path = require(&apos;path&apos;)
const cfg = require(&apos;../cfg&apos;)
const Fs = require(&apos;fs&apos;)
function resourcePathFrom (filepath) {
  let localpath = filepath
  while (Path.extname(localpath) != &apos;&apos;) {
    localpath = localpath.replace(Path.extname(localpath), &apos;&apos;)
  }
  if (!localpath.startsWith(cfg.resDir)) localpath = Path.join(cfg.resDir, localpath)
  return localpath
}

function jsonPathFrom (filepath) {
  return resourcePathFrom(filepath) + &apos;.json&apos;
}

function loadJson (filepath) {
  //TODO: Better way of handling extenctions// move away from .x.y.z
  let hostPath = jsonPathFrom(filepath)
  if (Fs.existsSync(hostPath)) {
    const json = Fs.readFileSync(hostPath)
    const data = JSON.parse(json)
    return Object.assign({ hostPath }, data)
  } else {
    throw new Error(`No such json file: ${hostPath}`)
  }
}

function forPath (filepath) {
  const hostPath = jsonPathFrom(filepath)
  dbg(&apos;getTilesetFrom %o = %o&apos;, filepath, hostPath)
  let record = TileSets.collection.findOne({ hostPath: hostPath })
  if (record) {
    dbg(&apos;existing tileset located...&apos;)
    return TileSets(record)
  }
  dbg(&apos;loading tileset data...&apos;)
  const json = loadJson(hostPath)
  dbg(&apos;saving tileset data...&apos;)
  return TileSets(json)
}

function listTileSets () {
  return TileSets.collection.find({}).map((item) =&gt; item.name)
}
dbg(&apos;loaded&apos;)</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
